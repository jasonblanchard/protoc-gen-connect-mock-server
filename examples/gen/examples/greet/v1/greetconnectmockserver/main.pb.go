// Code generated by protoc-gen-connect-mock-server. DO NOT EDIT.
package main

import (
	connect_go "github.com/bufbuild/connect-go"
	context "context"
	"flag"
	"net/http"
	"time"
	"github.com/rs/cors"
	"golang.org/x/exp/slog"
	"golang.org/x/net/http2"
	"golang.org/x/net/http2/h2c"
	"github.com/go-faker/faker/v4"
	"github.com/jasonblanchard/protoc-gen-connect-mock-server/examples/gen/examples/greet/v1"
	"github.com/jasonblanchard/protoc-gen-connect-mock-server/examples/gen/examples/greet/v1/greetv1connect"

	"google.golang.org/protobuf/types/known/durationpb"

	"google.golang.org/genproto/googleapis/type/datetime"
)

var isDynamic bool

func getStringValue() string {
	if !isDynamic {
		return "string"
	}

	type Container struct {
		Value string
	}

	a := &Container{}
	err := faker.FakeData(a)

	if err != nil {
		return err.Error()
	}

	return a.Value
}

func getInt32Value() int32 {
	if !isDynamic {
		return 123
	}

	type Container struct {
		Value int32
	}

	a := &Container{}
	err := faker.FakeData(a)

	if err != nil {
		return 0
	}

	return a.Value
}

func getBoolValue() bool {
	if !isDynamic {
		return true
	}

	type Container struct {
		Value bool
	}

	a := &Container{}
	err := faker.FakeData(a)

	if err != nil {
		return true
	}

	return a.Value
}

func durationpb_NewMockDuration() *durationpb.Duration {
	mock := &durationpb.Duration{
		Seconds: 123,
		Nanos:   getInt32Value(),
	}
	return mock
}

func datetime_NewMockDateTime() *datetime.DateTime {
	mock := &datetime.DateTime{
		Year:    getInt32Value(),
		Month:   getInt32Value(),
		Day:     getInt32Value(),
		Hours:   getInt32Value(),
		Minutes: getInt32Value(),
		Seconds: getInt32Value(),
		Nanos:   getInt32Value(),
	}
	return mock
}

func datetime_NewMockTimeZone() *datetime.TimeZone {
	mock := &datetime.TimeZone{
		Id:      getStringValue(),
		Version: getStringValue(),
	}
	return mock
}

func greetv1_NewMockNested() *greetv1.Nested {
	mock := &greetv1.Nested{
		Test: getStringValue(),
	}
	return mock
}

func greetv1_NewMockGreetRequest() *greetv1.GreetRequest {
	mock := &greetv1.GreetRequest{
		Name: getStringValue(),
	}
	return mock
}

func greetv1_NewMockGreetResponse() *greetv1.GreetResponse {
	mock := &greetv1.GreetResponse{
		Greeting:   getStringValue(),
		Inner:      greetv1_NewMockNested(),
		Thingies:   []*greetv1.Nested{greetv1_NewMockNested()},
		Greetings:  []string{getStringValue(), getStringValue(), getStringValue()},
		BoolKind:   getBoolValue(),
		Int32Kind:  getInt32Value(),
		Sint32Kind: 123,
		BytesKind:  []byte{1, 2, 3},
		FloatKind:  123,
		Status:     greetv1.Status_STATUS_NOT_OK,
		CreatedAt:  datetime_NewMockDateTime(),
		DoubleKind: 123,
	}
	return mock
}

func greetv1_NewMockStatusRequest() *greetv1.StatusRequest {
	mock := &greetv1.StatusRequest{}
	return mock
}

func greetv1_NewMockStatusResponse() *greetv1.StatusResponse {
	mock := &greetv1.StatusResponse{
		Status: greetv1.Status_STATUS_NOT_OK,
	}
	return mock
}

type GreetServiceMockServer struct{}

func (GreetServiceMockServer) Greet(context.Context, *connect_go.Request[greetv1.GreetRequest]) (*connect_go.Response[greetv1.GreetResponse], error) {
	resp := &connect_go.Response[greetv1.GreetResponse]{}
	resp.Msg = greetv1_NewMockGreetResponse()
	return resp, nil
}

type StatusServiceMockServer struct{}

func (StatusServiceMockServer) Status(context.Context, *connect_go.Request[greetv1.StatusRequest]) (*connect_go.Response[greetv1.StatusResponse], error) {
	resp := &connect_go.Response[greetv1.StatusResponse]{}
	resp.Msg = greetv1_NewMockStatusResponse()
	return resp, nil
}

func main() {
	var portVar string
	flag.StringVar(&portVar, "port", "8080", "port to run the mock server on")
	flag.StringVar(&portVar, "p", "8080", "port to run the mock server on (shorthand)")
	flag.BoolVar(&isDynamic, "d", false, "return dynamic values (shorthand)")

	flag.Parse()

	mux := http.NewServeMux()

	GreetServiceserver := &GreetServiceMockServer{}
	GreetServicepath, GreetServicehandler := greetv1connect.NewGreetServiceHandler(GreetServiceserver)
	mux.Handle(GreetServicepath, WithLogging(GreetServicehandler))

	StatusServiceserver := &StatusServiceMockServer{}
	StatusServicepath, StatusServicehandler := greetv1connect.NewStatusServiceHandler(StatusServiceserver)
	mux.Handle(StatusServicepath, WithLogging(StatusServicehandler))

	corsHandler := cors.New(cors.Options{
		AllowedOrigins:   []string{"https://buf.build"},
		AllowCredentials: true,
		AllowedMethods:   []string{http.MethodPost, http.MethodOptions},
		AllowedHeaders:   []string{"*"},
	}).Handler(mux)
	slog.Info("Server starting", "port", portVar)
	http.ListenAndServe(":"+portVar, h2c.NewHandler(corsHandler, &http2.Server{}))
}

func WithLogging(h http.Handler) http.Handler {
	logFn := func(rw http.ResponseWriter, r *http.Request) {
		start := time.Now()

		h.ServeHTTP(rw, r)

		duration := time.Since(start)

		slog.Info("request", "proto", r.Proto, "method", r.Method, "host", r.Host, "uri", r.RequestURI, "remoteAddr", r.RemoteAddr, "duration", duration)
	}
	return http.HandlerFunc(logFn)
}
